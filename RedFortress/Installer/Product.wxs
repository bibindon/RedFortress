<?xml version="1.0" encoding="utf-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">
    <Product Id="*" Name="starman" Language="1041" Version="0.0.0.1" Manufacturer="bibindon" UpgradeCode="cea4510f-a56d-42cd-a38c-a03f64ae6630">
        <Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" Platform="x64" />

        <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />
        <MediaTemplate EmbedCab="yes" />

        <Feature Id="ProductFeature" Title="Installer" Level="1">
            <ComponentGroupRef Id="ProductComponents" />
            <ComponentGroupRef Id="MyAppFiles" />
            <ComponentRef Id="RemoveAppDataComponent" />
        </Feature>
        
        <UIRef Id="WixUI_Minimal"/>
        <WixVariable Id="WixUILicenseRtf" Value="license.rtf" />
        <WixVariable Id="WixUIBannerBmp" Value="banner.bmp" />
        <WixVariable Id="WixUIDialogBmp" Value="banner2.bmp" />

        <Property Id="APP_DATA_STARMAN">
            <DirectorySearch Id="SearchAppData" Path="[AppDataFolder]">
                <DirectorySearch Id="SearchStarmanFolder" Path="Starman" />
            </DirectorySearch>
        </Property>

        <Icon Id="MyAppIcon.exe" SourceFile="$(var.starman.TargetPath)" />
        <Property Id="ARPPRODUCTICON" Value="MyAppIcon.exe" />
        
    </Product>

    <Fragment>
        <Directory Id="TARGETDIR" Name="SourceDir">
            <Directory Id="AppDataFolder">
                <Directory Id="StarmanAppDataDir" Name="Starman">
                    <Component Id="RemoveAppDataComponent" Guid="9E62E537-9F2F-4F3D-BE35-2F62FD5A3F7E">
                        <RemoveFile Id="RemoveAllFiles" Name="*" On="uninstall" Directory="StarmanAppDataDir" />

                        <util:RemoveFolderEx On="uninstall"
                                             Property="APP_DATA_STARMAN" />

                        <!-- Remove the Starman folder itself -->
                        <RemoveFolder Id="RemoveStarmanFolder" On="uninstall" Directory="StarmanAppDataDir" />


                        <RegistryValue Root="HKCU"
                                       Key="Software\StarmanInstaller"
                                       Name="CleanupMarker"
                                       Type="integer"
                                       Value="1"
                                       KeyPath="yes" />
                    </Component>
                </Directory>
            </Directory>
            <Directory Id="ProgramMenuFolder">
            </Directory>
            <Directory Id="ProgramFiles64Folder">
                <Directory Id="INSTALLFOLDER" Name="starman">
                    <Directory Id="RESOURCE" Name="res">
                        <Directory Id="IMAGE" Name="image"/>
                        <Directory Id="SHADER" Name="shader"/>
                        <Directory Id="MODEL" Name="model"/>
                        <Directory Id="FONT" Name="font"/>
                        <Directory Id="SCRIPT_" Name="script">
                            <Directory Id="SCRIPT_ORIGIN" Name="origin"/>
                            <Directory Id="SCRIPT_DEMO" Name="demo"/>
                        </Directory>
                        <Directory Id="SOUND" Name="sound"/>
                    </Directory>
                </Directory>
            </Directory>
        </Directory>
    </Fragment>

    <Fragment>
        <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
            <Component Id="ProductComponent" Guid="*">
                <File Id="WixInstallerEXE" Name="starman.exe" Source="$(var.starman.TargetPath)" KeyPath="yes">
                    <Shortcut Id="WixInstStartmenu" Directory="ProgramMenuFolder"
                              Name="starman" WorkingDirectory="INSTALLFOLDER"
                              Advertise="yes">
                        <Icon Id="WixInstIco.exe" SourceFile="$(var.starman.TargetPath)"/>
                    </Shortcut>
                </File>
            </Component>
            <Component Guid="*">
                <?if $(var.Configuration) = Debug ?>
                <File Source="$(var.starman.TargetDir)d3dx9d_43.dll" KeyPath="yes"/>
                <?else?>
                <File Source="$(var.starman.TargetDir)d3dx9_43.dll" KeyPath="yes"/>
                <?endif?>
            </Component>
            <Component Guid="*">
                <File Source="$(var.starman.TargetDir)D3DCompiler_43.dll" KeyPath="yes"/>
            </Component>
        </ComponentGroup>
        <ComponentGroup Id = "MyAppFiles">

            <Component Directory="FONT" Guid="*" Win64="yes">
                <File Source="../starman/res/font/BIZUDMincho-Regular.ttf" />
            </Component>
        </ComponentGroup>
    </Fragment>
</Wix>
